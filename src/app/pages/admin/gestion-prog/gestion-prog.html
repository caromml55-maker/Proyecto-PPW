<main class="admin-page" role="main">
  <header class="admin-header" role="banner">
    <div class="header-content">
      <h1>Gesti√≥n de Programadores</h1>
      <div class="header-actions">
        <button class="btn btn-primary" (click)="initCreateMode()" aria-label="Agregar programador">+ Agregar Programador</button>
        <button class="btn btn-secondary" (click)="goToInicio()" aria-label="Ir al inicio">Inicio</button>
      </div>
    </div>
  </header>

  <div class="admin-content">

    @if (!isCreating) {
    <div class="view-section">
        
      <!-- COMBOBOX (Solo aparece aqu√≠) -->
      <div class="selector-container">
        <h2 class="selector-title">Seleccionar usuarios del sistema</h2>

        <div class="selector-grid">

          <!-- PROGRAMADORES (ya existente, con l√≥gica de edici√≥n) -->
          <div class="selector-block">
            <label for="selectProgramador">Programadores</label>
            <div class="custom-combobox" [class.active]="isOpenProg" [class.has-selection]="selectedProgramador">
              
              <div class="combobox-display" (click)="toggleDropdownProg()">
                <span class="display-text">
                  {{ getDisplayTextProg() || '-- Seleccionar programador --' }}
                </span>
                <span class="combobox-arrow">‚ñº</span>
              </div>

              <div class="combobox-dropdown" *ngIf="isOpenProg">
                <div class="dropdown-search">
                  <input 
                    type="text" 
                    [(ngModel)]="searchTextProg"
                    (input)="filterOptionsProg()"
                    placeholder="Buscar programador..."
                    class="search-input"
                    autofocus
                  >
                  <span class="search-icon">üîç</span>
                </div>

                <div class="dropdown-list">
                  <div *ngIf="filteredProgramadores.length === 0" class="no-results">
                    No se encontraron programadores
                  </div>
                  <div 
                    *ngFor="let programador of filteredProgramadores" 
                    class="dropdown-item" 
                    [class.selected]="programador.uid === selectedProgramador" 
                    (click)="selectProgramador(programador)"
                  >
                    <div class="user-info">
                      <div class="user-name">{{ programador.displayName || programador.name }}</div>
                      <div class="user-email">{{ programador.email }}</div>
                    </div>
                    <span *ngIf="programador.uid === selectedProgramador" class="checkmark">‚úì</span>
                  </div>
                </div>
              </div>
              <input type="hidden" [(ngModel)]="selectedProgramador">
            </div>
          </div>

          <!-- ADMINISTRADORES (solo visual, sin l√≥gica extra) -->
          <div class="selector-block">
            <label for="selectProgramador">Administradores</label>
            <div class="custom-combobox" [class.active]="isOpenAdmin" [class.has-selection]="selectedAdmin">
              <div class="combobox-display" (click)="toggleDropdownAdmin()">
                <span class="display-text">
                  {{ getDisplayTextAdmin() || '-- Seleccionar administrador --' }}
                </span>
                <span class="combobox-arrow">‚ñº</span>
              </div>

              <div class="combobox-dropdown" *ngIf="isOpenAdmin">
                <div class="dropdown-search">
                  <input 
                    type="text" 
                    [(ngModel)]="searchTextAdmin"
                    (input)="filterOptionsAdmin()"
                    placeholder="Buscar administrador..."
                    class="search-input"
                    autofocus
                  >
                  <span class="search-icon">üîç</span>
                </div>

                <div class="dropdown-list">
                  <div *ngIf="filteredAdmins.length === 0" class="no-results">
                    No se encontraron administradores
                  </div>
                  <div 
                    *ngFor="let admin of filteredAdmins" 
                    class="dropdown-item" 
                    [class.selected]="admin.uid === selectedAdmin" 
                    (click)="selectAdmin(admin)"
                  >
                    <div class="user-info">
                      <div class="user-name">{{ admin.displayName || admin.name }}</div>
                      <div class="user-email">{{ admin.email }}</div>
                    </div>
                    <span *ngIf="admin.uid === selectedAdmin" class="checkmark">‚úì</span>
                  </div>
                </div>
              </div>
              <input type="hidden" [(ngModel)]="selectedAdmin">
            </div>
          </div>

          <!-- USUARIOS NORMALES (solo visual) -->
          <div class="selector-block">
            <label for="selectProgramador">Usuarios</label>
            <div class="custom-combobox" [class.active]="isOpenUser" [class.has-selection]="selectedUsuario">
              <div class="combobox-display" (click)="toggleDropdown()">
                <span class="display-text">
                  {{ getDisplayText() || '-- Seleccionar usuario --' }}
                </span>
                <span class="combobox-arrow">‚ñº</span>
              </div>

              <div class="combobox-dropdown" *ngIf="isOpenUser">
                <div class="dropdown-search">
                  <input 
                    type="text" 
                    [(ngModel)]="searchText"
                    (input)="filterOptions()"
                    placeholder="Buscar usuario..."
                    class="search-input"
                    autofocus
                  >
                  <span class="search-icon">üîç</span>
                </div>

                <div class="dropdown-list">
                  <div *ngIf="filteredUsuarios.length === 0" class="no-results">
                    No se encontraron usuarios
                  </div>
                  <div 
                    *ngFor="let usuario of filteredUsuarios" 
                    class="dropdown-item" 
                    [class.selected]="usuario.uid === selectedUsuario" 
                    (click)="selectUsuario(usuario)"
                  >
                    <div class="user-info">
                      <div class="user-name">{{ usuario.displayName || usuario.name }}</div>
                      <div class="user-email">{{ usuario.email }}</div>
                    </div>
                    <span *ngIf="usuario.uid === selectedUsuario" class="checkmark">‚úì</span>
                  </div>
                </div>
              </div>
              <input type="hidden" [(ngModel)]="selectedUsuario">
            </div>
          </div>
        </div>

        <div *ngIf="loading" class="select-loading-spinner">
          <div class="spinner-border spinner-border-sm text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
          </div>
        </div>

        <!-- Error message -->
        <div *ngIf="errorMsg" class="alert alert-danger mt-2">
          {{ errorMsg }}
        </div>
      </div>


      <!-- TARJETA DE INFORMACI√ìN (Aparece al seleccionar) -->
      @if (selectedUser) {
        <div class="card-detail">
          <!-- 1. FOTO AL INICIO (Requisito cumplido) -->
          <div class="photo-center">
            @if (formData.photoURL) {
              <img [src]="formData.photoURL" class="profile-img-lg" alt="Foto del programador">
            } @else {
              <div class="no-photo-placeholder">Sin Foto</div>
            }
          </div>
          
          <!-- 2. CAMPOS DE DATOS -->
          <div class="form-grid">
            <div class="form-group">
              <label>Nombre</label>
              <input type="text" [(ngModel)]="formData.displayName" (input)="soloLetras('displayName')"  [disabled]="!isEditing" aria-label="Nombre del usuario" required>
            </div>
            
            <div class="form-group">
              <label>Email</label>
              <input type="email" [(ngModel)]="formData.email" (input)="soloEmail('email')" [disabled]="!isEditing" aria-label="email">
            </div>
            
            <div class="form-group">
              <label>Especialidad</label>
              <input type="text" [(ngModel)]="formData.especialidad"  (input)="soloLetras('especialidad')"  [disabled]="!isEditing" aria-label="especialidad">
            </div>
            
            <div class="form-group">
              <label>Rol</label>
              <input type="text" [(ngModel)]="formData.role" [disabled]="!isEditing" aria-label="rol">
            </div>
            
            <div class="form-group">
              <label>Contacto</label>
              <input type="text" [(ngModel)]="formData.telefono"  (input)="soloNumeros('telefono')"  maxlength="10" [disabled]="!isEditing" placeholder="099 999 9999" aria-label="contacto">
            </div>
            
            <!-- REDES SOCIALES -->
            <div class="form-group full-row">
              <label class="section-label">Redes Sociales</label>
              <div class="social-inputs">
                <input type="text" [(ngModel)]="formData.redesSociales.github" pattern="https?://.+"  [disabled]="!isEditing" placeholder="GitHub URL" aria-label="github">
                <input type="text" [(ngModel)]="formData.redesSociales.linkedin" pattern="https?://.+"   [disabled]="!isEditing" placeholder="LinkedIn URL" aria-label="linkedin">
                <input type="text" [(ngModel)]="formData.redesSociales.portfolio"  [disabled]="!isEditing" placeholder="portafolios">
              </div>
            </div>
            
            <!-- 3. DESCRIPCI√ìN AL FINAL (Requisito cumplido) -->
            <div class="form-group full-row">
              <label>Descripci√≥n Profesional</label>
              <textarea rows="4" [(ngModel)]="formData.descripcion" [disabled]="!isEditing"></textarea>
            </div>
          </div>
          
          <!-- 4. BOTONES DE ACCI√ìN -->
          <div class="action-buttons">
            @if (!isEditing) {
              <!-- MODO LECTURA: Ver Editar/Eliminar -->
              <button class="btn btn-warning" (click)="enableEditMode()" aria-label="Editar informaci√≥n">‚úèÔ∏è Editar</button>
              <button class="btn btn-danger" (click)="deleteProgramador()" aria-label="Eliminar usuario">üóëÔ∏è Eliminar</button>
            } @else {
              <!-- MODO EDICI√ìN: Ver Guardar/Cancelar -->
              <button class="btn btn-success" (click)="saveUser()" aria-label="guardar usuario">üíæ Guardar Cambios</button>
              <button class="btn btn-secondary" (click)="cancelAction()" aria-label="cancelar accion">Cancelar</button>
            }
          </div>
        </div>
        }
      </div>
      }

      <!-- ======================================================= -->
      <!-- PARTE 2: AGREGAR PROGRAMADOR (Solo si isCreating es TRUE) -->
      <!-- ======================================================= -->
      @if (isCreating) {

        <form #progForm="ngForm" (ngSubmit)="saveUser(progForm)">
          <div class="create-section">
            <h2>Agregar Nuevo Programador</h2>
        

            <div class="form-grid">
              <div class="form-group">
                <label>Nombre </label>
                <input type="text" name="displayName" [(ngModel)]="formData.displayName" pattern="[A-Za-z√Å√â√ç√ì√ö√°√©√≠√≥√∫√ë√±\s']+" maxlength="40" title="Solo letras y espacios" oninput="this.value = this.value.replace(/[^A-Za-z√Å√â√ç√ì√ö√°√©√≠√≥√∫√ë√±\s]/g, '')">
              </div>
              <div class="form-group">
                <label>Email *</label>
                <input type="email" name="email" [(ngModel)]="formData.email" (input)="soloEmail('email')"title="Debe ser un correo v√°lido @gmail.com" required>
              </div>
              <div class="form-group">
                <label>Especialidad</label>
                <input type="text" name="especialidad" [(ngModel)]="formData.especialidad"  pattern="[A-Za-z√Å√â√ç√ì√ö√°√©√≠√≥√∫√ë√±\s']+" maxlength="40" title="Solo letras y espacios" oninput="this.value = this.value.replace(/[^A-Za-z√Å√â√ç√ì√ö√°√©√≠√≥√∫√ë√±\s]/g, '')">
              </div>
              <div class="form-group">
                <label>Contacto</label>
                <input type="text" name="telefono" [(ngModel)]="formData.telefono" placeholder="099 999 9999" pattern="[0-9]+" maxlength="13" minlength="10" title="Solo n√∫meros, m√≠nimo 10, m√°ximo 13" oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0,13)" onkeydown="return !['e','E','+','-','.'].includes(event.key)">
      </div>
              </div>

              <div class="form-group full-row">
                <label class="section-label">Redes Sociales</label>
                <div class="social-inputs">
                  <input type="text" name="github" [(ngModel)]="formData.redesSociales.github" placeholder="https://github.com/..." pattern="https?://.+" #gitCtrl="ngModel">
                  <input type="text" name="linkedin" [(ngModel)]="formData.redesSociales.linkedin" placeholder="https://linkedin.com/..." pattern="https?://.+" #linkCtrl="ngModel">
                  <input type="text" name="portafolio"  [(ngModel)]="formData.redesSociales.portfolio" placeholder="https://miweb.com" pattern="https?://.+">
                </div>
                <small *ngIf="gitCtrl.invalid || linkCtrl.invalid" class="text-danger">
                  Las URLs deben comenzar con http:// o https://
                </small>
              </div>

              <!-- DESCRIPCI√ìN AL FINAL -->
              <div class="form-group full-row">
                <label>Descripci√≥n Profesional</label>
                <textarea rows="4" name="descripcion" [(ngModel)]="formData.descripcion"></textarea>
              </div>
            </div>

            <div class="action-buttons">
              <!-- BOT√ìN GUARDAR VISIBLE -->
              <button class="btn btn-success" type="submit" [disabled]="progForm.invalid">‚úÖ Guardar Programador</button>
              <button class="btn btn-secondary" (click)="cancelAction()">Cancelar</button>
            </div>
        </form>
      }
  </div>
  
</main>